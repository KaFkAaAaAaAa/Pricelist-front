{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Offer" %}{% endblock %}

{% block content %}
    <div id="successAlert" class="alert alert-success alert-dismissible fade show alert-custom" role="alert" style="display: none;">
        {% trans "Item added successfully!" %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div class="container py-4" style="max-width: 900px;">
        <h1 class="text-center">
            {% if request.session.logged_user.user %}
                {% trans "New proposition" %}
            {% else %}
                {% trans "New offer" %}
            {% endif %}
        </h1>

        <form method="POST" class="mt-3" onsubmit="return validateOffer();" id="edit-form">
            {% csrf_token %}
            <input type="hidden" name="mode" id="mode" />
 
            {% if not request.session.logged_user.user %}
                <div class="mb-3 text-center">
                    <label for="client" class="form-label h5">{% trans "Client" %}:</label>
                    <select name="client" class="form-select" style="max-width: 300px; margin: 0 auto;">
                        {% for client in clients %}
                            <option value="{{ client }}">{{ client }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}

            <button type="button" data-bs-toggle="modal" data-bs-target="#searchModal"
                class="btn btn-sm btn-outline-success mt-2 mb-2">
                    {% trans "Add item" %}
            </button>
            <div class="table-responsive">
                <table class="table table-bordered text-center mt-3">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">{% trans "SKU" %}</th>
                        <th scope="col" class="text-start">{% trans "Product" %}</th>
                        <th scope="col">{% trans "Amount" %}</th>
                        <th scope="col">{% trans "Price" %}</th>
                        <th scope="col" class="text-end">{% trans "Total" %}</th>
                        <th></th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if request.session.current_offer %}
                        {% for item in request.session.current_offer %}
                        <tr id={{ item.sku }}>
                                <input type="hidden" name="sku-{{ item.sku }}" value={{ item.sku }}/>
                                <td>{{ item.sku }}</td>
                                <input type="hidden" name="name-{{ item.sku }}" value={{ item.name }}/>
                                <td class="text-start">{{ item.name }}</td>
                                <td>
                                    <div class="input-group text-center" style="margin: 0 auto;">
                                        <input id="amount-{{ item.sku }}" name="amount" type="number"
                                               value="{{ item.amount }}" min="0.1" step="0.1"
                                               class="form-control ms-auto separator-input" style="max-width: 100px;"
                                               onchange="calculateTotal('{{ item.sku }}')">
                                        <span class="input-group-text me-auto">kg<span>
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group">
                                        <input id="price-{{ item.sku }}" name="price-{{ item.sku }}" type="number" value="{{ item.price }}"
                                               min="0.1" step="0.01" class="form-control ms-auto separator-input" style="max-width: 100px; margin: 0;"
                                               onchange="calculateTotal('{{ item.sku }}')"><span class="input-group-text me-auto">€<span>
                                    </div>
                                </td>
                                <td class="text-end" style="white-space: nowrap;"><span class="separator" id="totalPrice-{{ item.sku }}">{{ item.total }}</span> €</td>
                                <input type="hidden" name="additionalInfo-{{ item.sku }}" id="additionalInfo-{{ item.sku }}" value="{{ item.additionalInfo }}" />
                                <td id="comment-{{item.sku}}">{{ item.additionalInfo }}</td>
                                <td>
                                    <div class="d-grid gap-1 w-100">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-target="#commentModal" data-bs-toggle="modal" data-bs-sku="{{ item.sku }}">{% trans "Add comment" %}</button>
                                        <button class="btn btn-outline-danger btn-sm" type="button" onclick="deleteItem(event, '{{ item.sku }}')">{% trans "Delete" %}</button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center" id="alert-no-items">
                                <div class="alert alert-secondary">
                                    {% trans "No items added to the offer, add some items from the price list" %}
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
            <hr>
            <div class="text-end mt-3">
                <h5 style="white-space: nowrap;"><strong>{% trans "Total price" %}:</strong> <span id="totalPrice">{{ totals.price }}</span> €</h5>
                <h5 style="white-space: nowrap;"><strong>{% trans "Total quantity" %}:</strong> <span id="totalAmount">{{ totals.mass }}</span> kg</h5>
            </div>
            <hr>
            <h3 class="mt-4">{% trans "Comment" %}</h3>
            <textarea name="transaction_description" class="form-control" rows="3" style="max-width: 100%;"></textarea>

            <button type="submit" name="action" value="make" class="btn btn-success mt-3 float-end">
                {% if request.session.logged_user.user %}{% trans "Make proposition" %}{% else %}
                    {% trans "Make offer" %}{% endif %}
            </button>
            <button id="saveButton" name="action" class="btn btn-success mt-3" style="display: none;" value="save" type="submit">{% trans "Save changes" %}</button>
        </form>
    </div>

    <div class="modal fade" id="emptyOfferModal" tabindex="-1" aria-labelledby="emptyOfferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emptyOfferModalLabel">{% trans "Warning" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% trans "You cannot submit an empty offer." %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Add comment" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="comment">{% trans "Comment" %}:</label>
        <input type="text" class="form-control" id="comment"/>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
        <button type="button" class="btn btn-primary" id="modalSaveButton">{% trans "Save changes" %}</button>
      </div>
    </div>
  </div>
</div>
<div class="modal" id="searchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Add item" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="comment">{% trans "Search" %}:</label>
        <input type="text" class="form-control" id="searchQuery"/>
        <p class="text-body-secondary mb-2">{% trans "Empty search query returns all items" %}</p>
        <div id="searchResults"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
        <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal" onclick="addItemToTransaction('', '', 0)">{% trans "Create new item" %}</button>
        <button type="button" class="btn btn-primary" id="searchBtn">{% trans "Search" %}</button>
      </div>
    </div>
  </div>
</div>
    <script>
    let skus = [{% for item in request.session.current_offer %}"{{ item.sku }}"{% if not forloop.last %}, {% endif %}{% endfor %}];

    function checkSkuList() {
        const noItemsAlert = document.getElementById("alert-no-items");
        if (skus.length === 0) {
            noItemsAlert.style.display = "";
        } else {
            noItemsAlert.style.display = "none";
        }
    }

    function getNextSku() {
        let prefix = "NA"; // Fixed prefix
        let maxNumber = 0;

        skus.forEach(sku => {
            let match = sku.match(/^NA(\d\d)$/);
            if (match) {
                let num = parseInt(match[1], 10);
                if (num > maxNumber) {
                    maxNumber = num;
                }
            }
        });

        let nextNumber = (maxNumber + 1).toString().padStart(2, '0'); // Ensure 2-digit format
        return `${prefix}${nextNumber}`;
    }
    const modalSaveButton = document.getElementById('modalSaveButton');

    modalSaveButton.addEventListener("click", event => {
        event.preventDefault();
        if (!sku) return;
        const inputComment = document.getElementById(`additionalInfo-${sku}`); 
        if (inputComment) {
            inputComment.value = document.getElementById('comment').value;
            comment = document.getElementById(`comment-${sku}`)
            // TODO: add the link (optional)
            if (comment) comment.textContent = inputComment.value;
            saveButton.style.display = "inline-block";
        }
        const modal = bootstrap.Modal.getInstance(commentModal);
        modal.hide();
    });

    function deleteItem(event, sku) {
        event.stopPropagation();

        if (confirm('{% trans "Are you sure you want to delete this item" %}?')) {
            let itemElement = document.getElementById(sku);
            if (itemElement) {
                itemElement.remove();
            }
            skus = skus.filter(itemSku => itemSku !== sku);
        }
        saveButton.style.display = "inline-block";
        checkSkuList();
    }

    function calculateTotal(skuChanged) {
        let allTotalPrice = 0.0, allTotalAmount = 0.0;
        let amount = parseFloat(document.getElementById(`amount-${skuChanged}`).value) || 0;
        let pricePerKg = parseFloat(document.getElementById(`price-${skuChanged}`).value) || 0;
        document.getElementById(`totalPrice-${skuChanged}`).textContent = (amount * pricePerKg).toFixed(2);

        skus.forEach(sku => {
            let amount = parseFloat(document.getElementById(`amount-${sku}`).value) || 0;
            let pricePerKg = parseFloat(document.getElementById(`price-${sku}`).value) || 0;
            allTotalPrice += amount * pricePerKg;
            allTotalAmount += amount;
        });

        document.getElementById(`totalPrice`).textContent = allTotalPrice.toFixed(2);
        document.getElementById(`totalAmount`).textContent = allTotalAmount.toFixed(1);
    }

    function addItemToTransaction(sku, name, price) {
        let newRow = document.createElement("tr");
        if (sku) {
            newRow.innerHTML = `<td><img style="width: 80px; height: auto; vertical-align: middle;" src="/images/${sku}.M.jpg"></td>
        <input type="hidden" name="sku-${sku}" />
        <td>${sku}</td>
        <input type="hidden" name="sku-${sku}" value="${sku}"/>
        <td class="text-start">
        ${sku}
        </td>
        <input id="name-${sku}" name="name-${sku}" type="text"
            value="${name}" class="ms-auto form-control"/>`
        } else {
            sku = getNextSku();
        }
        skus.push(sku);
        checkSkuList();
        newRow.innerHTML = `<td>${sku}</td>
        <td class="text-start">
            <input id="name-${sku}" name="name-${sku}" type="text"
                value="${name}" class="ms-auto form-control"/>
        </td>
                    <td>
                        <div class="input-group text-center" style="margin: 0 auto;">
                        <input id="amount-${sku}" name="amount-${sku}" type="number"
                                   value="0" min="0.1" step="0.1"
                                   class="form-control ms-auto separator-input" style="max-width: 100px;"
                                   onchange="calculateTotal('${sku}')">
                            <span class="input-group-text me-auto">kg<span>
                        </div>
                    </td>
                    <td>
                        <div class="input-group">
                            <input id="price-${sku}" name="price-${sku}" type="number" value="0"
                                   min="0.1" step="0.01" class="form-control ms-auto separator-input" style="max-width: 100px; margin: 0;"
                                   onchange="calculateTotal('${sku}')"><span class="input-group-text me-auto">€<span>
                        </div>
                    </td>
                    <td class="text-end" style="white-space: nowrap;"><span class="separator" id="totalPrice-${sku}"></span> €</td>
                    <input type="hidden" name="additionalInfo-${sku}" id="additionalInfo-${sku}" />
                    <td id="comment-${sku}"></td>
                    <td>
                        <div class="d-grid gap-1 w-100">
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-target="#commentModal" data-bs-toggle="modal" data-bs-sku="${sku}">{% trans "Add comment" %}</button>
                            <button class="btn btn-outline-danger btn-sm" type="button" onclick="deleteItem(event, '${sku}')">{% trans "Delete" %}</button>
                        </div>
                    </td>
                `;
        newRow.id = sku;
        document.querySelector("table tbody").appendChild(newRow);
        calculateTotal(sku);
        saveButton.style.display = "inline-block";
        showSuccessAlert();
    }

    function showSuccessAlert() {
        successAlert.style.display = "block";
        setTimeout(() => {
            successAlert.style.display = "none";
        }, 3000);
    }

    const successAlert = document.getElementById("successAlert");
    function validateOffer() {
        if (skus.length === 0) {
            var emptyOfferModal = new bootstrap.Modal(document.getElementById('emptyOfferModal'));
            emptyOfferModal.show();
            return false;
        }
        return true;
    }

    const commentModal = document.getElementById('commentModal');
    if (commentModal) {
        commentModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            sku = button.getAttribute('data-bs-sku');

            const inputComment = document.getElementById(`additionalInfo-${sku}`); 
            const commentInput = document.getElementById('comment');
            if (inputComment) {
                commentInput.value = inputComment.value;
            }
        });
    }
    const form = document.getElementById("edit-form");
    const inputs = form.querySelectorAll("input, textarea");
    const saveButton = document.getElementById("saveButton");

    inputs.forEach(input => {
        input.addEventListener("input", () => {
            saveButton.style.display = "inline-block";
        });
    });

    form.addEventListener("submit", function (event) {
        const submitButton = document.activeElement;
        {% if transaction.status == "PROGNOSE" %}
        if ( inputField && inputField.value )
            addPlate(inputField.value);
        {% endif %}
        if (submitButton && submitButton.type === "submit") {
            if (!confirm("{% trans "Are you sure you want to save changes?" %}")) {
                event.preventDefault();
            }
        }
    });

    document.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            let searchModal = document.getElementById("searchModal");
            if (searchModal.classList.contains("show")) {
                event.preventDefault();
                document.getElementById("searchBtn").click();
            }
        }
    });

    document.getElementById("searchBtn").addEventListener("click", function (event) {
        event.preventDefault();

        let query = document.getElementById("searchQuery").value.trim();

        if (!query)
            url = "/?f=json";
        else
            url = `/?search=${query}&f=json`

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let resultsContainer = document.getElementById("searchResults");
                resultsContainer.innerHTML = "";
                
                if (data.items.length === 0) {
                    resultsContainer.innerHTML = "<p>No items found.</p>";
                    return;
                }

                let resultList = document.createElement("ul");
                resultList.classList.add("list-group");


                Object.entries(data.items).forEach(([category, categoryItems]) =>{
                    if (categoryItems.length === 0) {
                        return;
                    }
                    let listItem = document.createElement("li");
                    listItem.innerHTML = `<strong>${category}</strong>`;
                    listItem.classList.add("list-group-item", "text-left", "text-light", "fw-semibold", "text-uppercase", "align-middle");
                    listItem.style.backgroundColor = "#9E0F06";
                    resultList.appendChild(listItem);
                    categoryItems.forEach(item => {
                        let listItem = document.createElement("li");
                        listItem.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center");

                        listItem.innerHTML = `
                            <span><strong>${item.sku}</strong> - ${item.name} (€${item.price}/kg)</span>
                            <button class="btn btn-sm btn-outline-success" data-bs-dismiss="modal" onclick="addItemToTransaction('${item.sku}', '${item.name}', ${item.price})">Add</button>
                        `;
                        resultList.appendChild(listItem);
                    });

                });

                resultsContainer.appendChild(resultList)
            })
            .catch(error => console.error("Error fetching items: " + error));
    });
    
    window.onload = () => skus.forEach(sku => calculateTotal(sku));
    </script>
{% endblock %}
