{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Offer" %}{% endblock %}

{% block content %}
    <div class="container py-4" style="max-width: 900px;">
        <h1 class="text-center">
            {% if request.session.logged_user.user %}
                {% trans "New proposition" %}
            {% else %}
                {% trans "New offer" %}
            {% endif %}
        </h1>

        <form method="POST" class="mt-3" onsubmit="return validateOffer()">
            {% csrf_token %}

            {% if not request.session.logged_user.user %}
                <div class="mb-3 text-center">
                    <label for="client" class="form-label h5">{% trans "Client" %}:</label>
                    <select name="client" class="form-select" style="max-width: 300px; margin: 0 auto;">
                        {% for client in clients %}
                            <option value="{{ client }}">{{ client }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}

            <div class="table-responsive">
                <table class="table table-bordered text-center mt-3">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">{% trans "SKU" %}</th>
                        <th scope="col" class="text-start">{% trans "Product" %}</th>
                        <th scope="col">{% trans "Amount" %}</th>
                        <th scope="col">{% trans "Price" %}</th>
                        <th scope="col" class="text-end">{% trans "Total" %}</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if request.session.current_offer %}
                        {% for item in request.session.current_offer %}
                            <tr>
                                <td>{{ item.sku }}</td>
                                <td class="text-start">{{ item.name }}</td>
                                <td>
                                    <div class="input-group text-center" style="margin: 0 auto;">
                                        <input id="amount-{{ item.sku }}" name="amount" type="number"
                                               value="{{ item.amount }}" min="0.1" step="0.1"
                                               class="form-control ms-auto separator-input" style="max-width: 100px;"
                                               onchange="calculateTotal('{{ item.sku }}')">
                                        <span class="input-group-text me-auto">kg<span>
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group">
                                        <input id="price-{{ item.sku }}" name="price" type="number" value="{{ item.price }}"
                                               min="0.1" step="0.01" class="form-control ms-auto separator-input" style="max-width: 100px; margin: 0;"
                                               onchange="calculateTotal('{{ item.sku }}')"><span class="input-group-text me-auto">€<span>
                                    </div>
                                </td>
                                <td class="text-end" style="white-space: nowrap;"><span class="separator" id="totalPrice-{{ item.sku }}">{{ item.total }}</span> €</td>
                                <td>

                                <div class="d-grid gap-1">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" href="/transactions/offer/{{ item.sku }}/edit/">{% trans "Add comment" %}</button>
                                    <a class="btn btn-outline-danger btn-sm"
                                        onclick="return confirm('{% trans "Are you sure you want to delete this item?" %}');"
                                        href="/transactions/offer/{{ item.sku }}/delete/">{% trans "Delete" %}</a>
                                </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="alert alert-secondary">
                                    {% trans "No items added to the offer, add some items from the price list" %}
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
            <hr>
            <div class="text-end mt-3">
                <h5 style="white-space: nowrap;"><strong>{% trans "Total price" %}:</strong> <span id="totalPrice">{{ totals.price }}</span> €</h5>
                <h5 style="white-space: nowrap;"><strong>{% trans "Total quantity" %}:</strong> <span id="totalAmount">{{ totals.mass }}</span> kg</h5>
            </div>
            <hr>
            <h3 class="mt-4">{% trans "Comment" %}</h3>
            <textarea name="transaction_description" class="form-control" rows="3" style="max-width: 100%;"></textarea>

            <button type="submit" class="btn btn-success mt-3 float-end">
                {% if request.session.logged_user.user %}{% trans "Make proposition" %}{% else %}
                    {% trans "Make offer" %}{% endif %}
            </button>
        </form>
    </div>

    <div class="modal fade" id="emptyOfferModal" tabindex="-1" aria-labelledby="emptyOfferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emptyOfferModalLabel">{% trans "Warning" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% trans "You cannot submit an empty offer." %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function calculateTotal(skuChanged) {
            let allTotalPrice = 0.0, allTotalAmount = 0.0;
            let amount = parseFloat(document.getElementById(`amount-${skuChanged}`).value) || 0;
            let pricePerKg = parseFloat(document.getElementById(`price-${skuChanged}`).value) || 0;
            document.getElementById(`totalPrice-${skuChanged}`).textContent = (amount * pricePerKg).toFixed(2);

            skus.forEach(sku => {
                let amount = parseFloat(document.getElementById(`amount-${sku}`).value) || 0;
                let pricePerKg = parseFloat(document.getElementById(`price-${sku}`).value) || 0;
                allTotalPrice += amount * pricePerKg;
                allTotalAmount += amount;
            });

            document.getElementById(`totalPrice`).textContent = allTotalPrice.toFixed(2);
            document.getElementById(`totalAmount`).textContent = allTotalAmount.toFixed(1);
        }

        function validateOffer() {
            if (skus.length === 0) {
                var emptyOfferModal = new bootstrap.Modal(document.getElementById('emptyOfferModal'));
                emptyOfferModal.show();
                return false;
            }
            return true;
        }

        const skus = [{% for item in request.session.current_offer %}"{{ item.sku }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
        window.onload = () => skus.forEach(sku => calculateTotal(sku));
    </script>
{% endblock %}
